# F-032: 전략 근본 재편 — Spread/O-U 중단, Paired Entry 확장

## Context

### 왜 이 변경이 필요한가
2/19 NBA 드라이런 결과: **1W-10L, ROI -42~-73%** ($309 투자 → -$165 확정 손실).
스프레드/O-U 마켓에서 스포츠북 devig 확률을 "fair value"로 사용하는 것이 **근본적으로 잘못됨**.

### 실패 근본 원인
1. **스포츠북 odds ≠ Polymarket 가격**: 스프레드/O-U 마켓에서 devig 확률(~0.50)은 Polymarket 가격(0.41-0.47)과 **무관**
2. **환상적 에지**: 봇이 "fair=0.50 vs price=0.43 → edge 7%"로 판단하지만, 이 에지는 존재하지 않음
3. **검증 없는 진입**: 적응형 캘리브레이션 코드가 있으나 실행되지 않음 (피드백 루프 부재)

### 검증된 성공 전략
- **크립토 페어드 엔트리**: +11.57% ROI (YES+NO 동시 매수, CPP < $0.94)
- 시장 중립 아비트라지 — 방향 예측 불필요, 수학적 차익

### 외부 리서치 핵심 발견
- Polymarket 지갑의 **7.6%만 수익** (0.04%가 전체 수익의 70% 차지)
- **캘리브레이션 > 정확도**: 캘리브레이션 최적화 모델 ROI +110% vs 정확도 최적화 -35%
- 아비트라지 $40M+ 문서화된 수익, 그러나 73%는 sub-100ms 봇이 차지
- **Paired entry(시장 중립)가 개인 트레이더의 현실적 에지**
- Half-Kelly 사이징 필수 — 대부분 예측이 아니라 사이징 실패로 파산

---

## 전략 변경 요약

| 항목 | Before (실패) | After (재편) |
|------|--------------|-------------|
| 스프레드/O-U | 활성 (11건 중 10패) | **완전 차단** |
| 크립토 페어드 | 비활성 | **주력 전략으로 복원** |
| 스포츠 페어드 | 미구현 | **신규 구현** (YES+NO CPP < 0.96) |
| 머니라인 방향 | min_edge 3% | **검증 게이트 추가** (20건 dry-run 필수) |
| 사이징 | Half-Kelly | **Eighth-Kelly** (검증 전) |

---

## 구현 계획

### Step 1: Spread/O-U 완전 차단 (F-032a)

**파일**: `src/poly24h/strategy/odds_api.py`
- `_get_fair_prob_generic()` 시작부에 spread/totals 타입이면 `return None`
- `_get_fair_prob_three_way()`에도 동일 적용

**파일**: `src/poly24h/strategy/sports_monitor.py`
- `scan_and_trade()` 내 `_detect_polymarket_type()` 결과가 spread/totals이면 skip

**테스트**: `tests/test_spread_ou_block.py` (신규)
- `test_spread_returns_none_fair_value`
- `test_ou_returns_none_fair_value`
- `test_moneyline_still_returns_fair_value`

### Step 2: 스포츠 Paired Entry 스캐너 (F-032b)

**파일**: `src/poly24h/strategy/sports_paired_scanner.py` (신규)
```python
class SportsPairedScanner:
    """모든 스포츠 마켓에서 YES+NO CPP < threshold 기회 탐색.

    Fair value 불필요 — 순수 시장 구조 아비트라지.
    """
    def __init__(self, orderbook_fetcher, position_manager,
                 cpp_threshold=0.96):
        ...

    async def scan_markets(self, markets: list[Market]) -> list[dict]:
        """각 마켓의 YES/NO best ask를 조회, CPP < threshold이면 기회."""
        ...
```

**파일**: `src/poly24h/main.py`
- `sniper_loop()` 내에서 스포츠 모니터와 병렬로 `SportsPairedScanner` 실행
- NBA/NHL 디스커버리 결과를 페어드 스캐너에 전달

**테스트**: `tests/test_sports_paired_scanner.py` (신규)
- `test_cpp_below_threshold_detected`
- `test_cpp_above_threshold_skipped`
- `test_insufficient_liquidity_skipped`

### Step 3: 머니라인 검증 게이트 (F-032c)

**파일**: `src/poly24h/strategy/moneyline_gate.py` (신규)
```python
class MoneylineValidationGate:
    MIN_TRADES = 20
    MIN_WIN_RATE = 0.48
    MIN_ROI = 0.0

    def is_validated(self) -> bool:
        """20건 이상 dry-run 후 수익성 확인 시 True."""
        ...
```

**파일**: `src/poly24h/strategy/sports_monitor.py`
- `try_enter()` 전에 게이트 체크 — 미검증 시 dry-run만 허용

**테스트**: `tests/test_moneyline_gate.py` (신규)
- `test_gate_blocks_before_20_trades`
- `test_gate_allows_after_positive_validation`
- `test_gate_blocks_negative_roi`

### Step 4: 크립토 페어드 엔트리 재활성화 확인

**파일**: `src/poly24h/scheduler/event_scheduler.py`
- 크립토 paired entry 파이프라인이 실제 마켓에서 작동 중인지 확인
- `PairedEntryDetector` → `ClobOrderbookFetcher` 연결 검증

**파일**: `.env.sports_validation`
- `POLY24H_SPORTS=nba,nhl` 유지 (페어드 스캐너용)
- `POLY24H_CPP_THRESHOLD=0.96` 추가

---

## 변경 파일 요약

| 파일 | 변경 | 유형 |
|------|------|------|
| `src/poly24h/strategy/odds_api.py` | spread/totals fair value 차단 | 수정 |
| `src/poly24h/strategy/sports_monitor.py` | market type 필터 + 검증 게이트 | 수정 |
| `src/poly24h/strategy/sports_paired_scanner.py` | 스포츠 CPP 페어드 스캐너 | **신규** |
| `src/poly24h/strategy/moneyline_gate.py` | 머니라인 검증 게이트 | **신규** |
| `src/poly24h/main.py` | SportsPairedScanner 연결 | 수정 |
| `tests/test_spread_ou_block.py` | spread/O-U 차단 테스트 | **신규** |
| `tests/test_sports_paired_scanner.py` | 페어드 스캐너 테스트 | **신규** |
| `tests/test_moneyline_gate.py` | 검증 게이트 테스트 | **신규** |
| `kitty-specs/F-032-strategy-overhaul/spec.md` | 스펙 | **신규** |

---

## GO/NO-GO 기준

### Day 3 (드라이런 리뷰)
- **GO**: 크립토 페어드 10+건 ROI > 3%, 스프레드/O-U 0건 진입
- **NO-GO**: 크립토 페어드 0건 → 마켓 구조 변화, 전략 폐기 검토

### Day 5 (라이브 승인 기준)
- **GO**: 페어드 15+건 ROI > 2%, 단일 거래 손실 < 뱅크롤 5%
- **NO-GO**: 드라이런 ROI < 1% → 크립토 전용으로 축소

---

## 예상 성과

| 시나리오 | 일 거래수 | 평균 ROI | 일 수익 | 7일 수익 |
|----------|----------|---------|---------|---------|
| 보수적 (크립토 페어드만) | 5-10 | 5-8% | $5-40 | $35-280 |
| 기대 (크립토+스포츠 페어드) | 8-15 | 4-10% | $15-80 | $105-560 |
| 최악 (기회 없음) | 0 | 0% | $0 | $0 |

---

## 검증

1. `pytest tests/test_spread_ou_block.py -v` — spread/O-U 차단 확인
2. `pytest tests/test_sports_paired_scanner.py -v` — 페어드 스캐너 동작 확인
3. `pytest tests/test_moneyline_gate.py -v` — 검증 게이트 동작 확인
4. 기존 24건 테스트 전체 통과
5. 드라이런 재시작 → 스프레드/O-U 진입 0건 확인
6. 크립토 페어드 엔트리 실제 마켓에서 CPP 기회 감지 확인
